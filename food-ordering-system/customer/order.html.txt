<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£</title>
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>üõí ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h1>
    </header>

    <div class="card" style="margin-bottom: 30px;">
      <input 
        type="text" 
        id="searchInput" 
        placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏°‡∏ô‡∏π ‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏Å‡πà‡∏ó‡∏≠‡∏î, ‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß..."
        onkeyup="filterRestaurants()"
        style="width: 100%; padding: 12px; font-size: 16px; border: 2px solid var(--primary); border-radius: 8px; outline: none;"
      >
      <div id="searchInfo" style="color: #666; margin-top: 10px;"></div>
    </div>

    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
      <div id="restaurantsContainer"></div>
      
      <div class="card" style="position: sticky; top: 20px; max-height: 600px; overflow-y: auto;">
        <h2 style="color: var(--primary); margin-bottom: 15px;">üõí ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</h2>
        <div id="cartItems" style="min-height: 100px; margin-bottom: 15px;">
          <p style="color: #999; text-align: center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á</p>
        </div>
        <hr style="margin: 15px 0;">
        <div style="display: flex; justify-content: space-between; font-size: 1.2em; font-weight: bold; margin-bottom: 10px;">
          <span>‡∏£‡∏ß‡∏°:</span>
          <span id="totalPrice">0‡∏ø</span>
        </div>
        <button id="orderBtn" class="btn btn-primary" style="width: 100%; padding: 12px;" disabled>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á</button>
        <a href="history.html" class="btn btn-primary" style="width: 100%; text-align: center; margin-top: 10px; text-decoration: none; display: block;">üìú ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</a>
      </div>
    </div>
  </div>

  <script type="module">
    import { getAllRestaurants } from "../js/restaurants.js";
    import { createOrder } from "../js/database.js";

    let cart = [];
    let filteredRestaurants = getAllRestaurants();

    window.filterRestaurants = function() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
      const infoEl = document.getElementById('searchInfo');

      if (searchTerm === '') {
        filteredRestaurants = getAllRestaurants();
        infoEl.textContent = '';
      } else {
        filteredRestaurants = getAllRestaurants()
          .map(rest => ({
            ...rest,
            items: rest.items.filter(item => item.name.toLowerCase().includes(searchTerm))
          }))
          .filter(rest => rest.items.length > 0);

        const totalMatches = filteredRestaurants.reduce((sum, r) => sum + r.items.length, 0);
        infoEl.textContent = `‚úÖ ‡∏û‡∏ö ${filteredRestaurants.length} ‡∏£‡πâ‡∏≤‡∏ô, ${totalMatches} ‡πÄ‡∏°‡∏ô‡∏π`;
      }
      renderRestaurants();
    };

    function renderRestaurants() {
      const container = document.getElementById('restaurantsContainer');
      
      if (filteredRestaurants.length === 0) {
        container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏°‡∏ô‡∏π</p>';
        return;
      }

      const grouped = {};
      filteredRestaurants.forEach(rest => {
        if (!grouped[rest.building]) grouped[rest.building] = [];
        grouped[rest.building].push(rest);
      });

      let html = '';
      Object.keys(grouped).sort().forEach(building => {
        html += `<div style="grid-column: 1/-1; background: var(--primary); color: white; padding: 15px; border-radius: 8px; margin-top: 10px; font-weight: bold;">üè¢ ${building}</div>`;
        
        grouped[building].forEach(rest => {
          html += `
            <div class="card">
              <h3 style="color: var(--primary); margin-bottom: 12px;">${rest.name}</h3>
              <div style="display: grid; gap: 8px;">
                ${rest.items.map((item) => `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--light); border-radius: 6px;">
                    <span style="font-weight: 500;">${item.name}</span>
                    <span style="color: var(--primary); font-weight: bold;">${item.price}‡∏ø</span>
                    <button class="btn btn-primary" onclick="addToCart('${rest.name}', '${item.name}', ${item.price})" style="padding: 6px 12px;">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        });
      });

      container.innerHTML = html;
    }

    window.addToCart = function(restaurant, item, price) {
      const existing = cart.find(c => c.restaurant === restaurant && c.item === item);
      if (existing) {
        existing.qty++;
      } else {
        cart.push({ restaurant, item, price, qty: 1 });
      }
      updateCartDisplay();
    };

    function updateCartDisplay() {
      const cartItems = document.getElementById('cartItems');
      const totalPrice = document.getElementById('totalPrice');
      const orderBtn = document.getElementById('orderBtn');

      if (cart.length === 0) {
        cartItems.innerHTML = '<p style="color: #999; text-align: center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á</p>';
        totalPrice.textContent = '0‡∏ø';
        orderBtn.disabled = true;
        return;
      }

      let total = 0;
      let html = '';

      cart.forEach((item, idx) => {
        const itemTotal = item.price * item.qty;
        total += itemTotal;
        html += `
          <div style="padding: 10px; background: var(--light); border-radius: 6px; margin-bottom: 8px; border-left: 4px solid var(--primary);">
            <div style="font-weight: bold;">${item.restaurant}</div>
            <div style="color: #666; font-size: 0.9em;">${item.name}</div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
              <div style="display: flex; gap: 5px;">
                <button onclick="updateQty(${idx}, -1)" style="width: 26px; height: 26px; background: var(--primary); color: white; border: none; border-radius: 3px; cursor: pointer;">‚àí</button>
                <span style="width: 30px; text-align: center; font-weight: bold;">${item.qty}</span>
                <button onclick="updateQty(${idx}, 1)" style="width: 26px; height: 26px; background: var(--primary); color: white; border: none; border-radius: 3px; cursor: pointer;">+</button>
              </div>
              <span style="color: var(--primary); font-weight: bold;">${itemTotal}‡∏ø</span>
              <button onclick="removeFromCart(${idx})" class="btn btn-danger" style="padding: 4px 8px;">‡∏•‡∏ö</button>
            </div>
          </div>
        `;
      });

      cartItems.innerHTML = html;
      totalPrice.textContent = total + '‡∏ø';
      orderBtn.disabled = false;
    }

    window.updateQty = function(idx, delta) {
      cart[idx].qty += delta;
      if (cart[idx].qty <= 0) {
        removeFromCart(idx);
      } else {
        updateCartDisplay();
      }
    };

    window.removeFromCart = function(idx) {
      cart.splice(idx, 1);
      updateCartDisplay();
    };

    document.getElementById('orderBtn').addEventListener('click', async () => {
      if (cart.length === 0) return;

      const items = [];
      let total = 0;

      cart.forEach(item => {
        const itemTotal = item.price * item.qty;
        total += itemTotal;
        items.push({
          restaurant: item.restaurant,
          item: item.item,
          price: item.price,
          qty: item.qty,
          subtotal: itemTotal
        });
      });

      try {
        const customerId = localStorage.getItem('customerId') || 'customer_' + Date.now();
        localStorage.setItem('customerId', customerId);

        const orderId = await createOrder({
          items: items,
          total: total,
          status: 'pending',
          customerId: customerId,
          shopName: items[0].restaurant
        });

        alert(`‚úÖ ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! #${orderId.substring(0, 8)}`);
        cart = [];
        updateCartDisplay();
      } catch (error) {
        alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
      }
    });

    renderRestaurants();
  </script>
</body>
</html>