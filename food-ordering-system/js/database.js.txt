import { 
  collection, 
  addDoc, 
  updateDoc, 
  doc,
  orderBy,
  onSnapshot,
  query,
  where
} from "firebase/firestore";
import { db } from "./config.js";

// ✅ Create Order
export async function createOrder(orderData) {
  try {
    const docRef = await addDoc(collection(db, "orders"), {
      ...orderData,
      createdAt: new Date(),
      updatedAt: new Date(),
      status: "pending"
    });
    return docRef.id;
  } catch (error) {
    console.error("Error creating order:", error);
    throw error;
  }
}

// ✅ Update Order Status
export async function updateOrderStatus(orderId, newStatus) {
  try {
    const orderRef = doc(db, "orders", orderId);
    await updateDoc(orderRef, { 
      status: newStatus,
      updatedAt: new Date()
    });
  } catch (error) {
    console.error("Error updating order:", error);
    throw error;
  }
}

// ✅ Listen to All Orders (Realtime)
export function listenToOrders(callback) {
  try {
    const q = query(
      collection(db, "orders"),
      orderBy("createdAt", "desc")
    );
    
    return onSnapshot(q, (snapshot) => {
      const orders = [];
      snapshot.forEach((doc) => {
        orders.push({ id: doc.id, ...doc.data() });
      });
      callback(orders);
    });
  } catch (error) {
    console.error("Error listening to orders:", error);
  }
}

// ✅ Listen to Shop Orders Only
export function listenToShopOrders(shopName, callback) {
  try {
    const q = query(
      collection(db, "orders"),
      where("shopName", "==", shopName),
      orderBy("createdAt", "desc")
    );
    
    return onSnapshot(q, (snapshot) => {
      const orders = [];
      snapshot.forEach((doc) => {
        orders.push({ id: doc.id, ...doc.data() });
      });
      callback(orders);
    });
  } catch (error) {
    console.error("Error listening to shop orders:", error);
  }
}