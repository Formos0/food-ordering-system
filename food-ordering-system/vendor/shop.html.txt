<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô</title>
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>üë®‚Äçüç≥ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h1>
      <p id="shopName" style="color: rgba(255,255,255,0.9);">-</p>
    </header>

    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('active')">üìã ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ñ‡πâ‡∏≤‡∏á</button>
      <button class="tab-btn" onclick="switchTab('history')">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
    </div>

    <div id="active" class="tab-content active">
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 30px;">
        <div class="card" style="text-align: center;">
          <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>
          <div style="font-size: 2em; font-weight: bold; color: #f59e0b;" id="statPending">0</div>
        </div>
        <div class="card" style="text-align: center;">
          <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</div>
          <div style="font-size: 2em; font-weight: bold; color: #8b5cf6;" id="statPreparing">0</div>
        </div>
        <div class="card" style="text-align: center;">
          <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö</div>
          <div style="font-size: 2em; font-weight: bold; color: #22c55e;" id="statReady">0</div>
        </div>
      </div>

      <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;" id="ordersContainer">
        <p style="text-align: center; color: #999; padding: 40px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</p>
      </div>
    </div>

    <div id="history" class="tab-content">
      <div style="display: grid; gap: 15px;" id="historyContainer">
        <p style="text-align: center; color: #999; padding: 40px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</p>
      </div>
    </div>

    <div style="margin-top: 20px; text-align: center;">
      <a href="dashboard.html" class="btn btn-primary" style="text-decoration: none;">‚Üê ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô</a>
      <a href="../index.html" class="btn btn-primary" style="text-decoration: none; margin-left: 10px;">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
    </div>
  </div>

  <script type="module">
    import { listenToShopOrders, updateOrderStatus } from "../js/database.js";

    const params = new URLSearchParams(window.location.search);
    const shopName = params.get('shop');

    if (!shopName) {
      alert('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡πâ‡∏≤‡∏ô');
      window.location.href = 'dashboard.html';
    }

    document.getElementById('shopName').textContent = `üè™ ${shopName}`;

    let unsubscribe;
    let allOrders = [];

    function startListening() {
      unsubscribe = listenToShopOrders(shopName, (orders) => {
        allOrders = orders;
        renderOrders();
        updateStats();
      });
    }

    function updateStats() {
      const active = allOrders.filter(o => !['picked', 'rejected'].includes(o.status));
      const pending = active.filter(o => o.status === 'pending').length;
      const preparing = active.filter(o => o.status === 'preparing').length;
      const ready = active.filter(o => o.status === 'ready').length;

      document.getElementById('statPending').textContent = pending;
      document.getElementById('statPreparing').textContent = preparing;
      document.getElementById('statReady').textContent = ready;
    }

    function renderOrders() {
      const active = allOrders.filter(o => !['picked', 'rejected'].includes(o.status));
      const container = document.getElementById('ordersContainer');

      if (active.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ñ‡πâ‡∏≤‡∏á</p>';
        return;
      }

      const statusTexts = {
        'pending': '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£',
        'accepted': '‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß',
        'preparing': '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥',
        'ready': '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö'
      };

      let html = '';
      active.forEach(order => {
        const itemsHtml = order.items
          .filter(item => item.restaurant === shopName)
          .map(item => `
            <div style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
              <div>${item.item}</div>
              <div style="color: #666; font-size: 0.9em;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${item.qty} ‡∏ä‡∏¥‡πâ‡∏ô √ó ${item.price}‡∏ø = ${item.subtotal}‡∏ø</div>
            </div>
          `).join('');

        let buttons = '';
        if (order.status === 'pending') {
          buttons = `
            <button onclick="acceptOrder('${order.id}')" class="btn btn-primary" style="width: 48%;">‚úÖ ‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
            <button onclick="rejectOrder('${order.id}')" class="btn btn-danger" style="width: 48%;">‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
          `;
        } else if (order.status === 'accepted') {
          buttons = `
            <button onclick="startPreparing('${order.id}')" class="btn btn-primary" style="width: 48%;">üë®‚Äçüç≥ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥</button>
            <button onclick="rejectOrder('${order.id}')" class="btn btn-danger" style="width: 48%;">‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
          `;
        } else if (order.status === 'preparing') {
          buttons = `
            <button onclick="markReady('${order.id}')" class="btn btn-primary" style="width: 48%;">üéâ ‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
            <button onclick="rejectOrder('${order.id}')" class="btn btn-danger" style="width: 48%;">‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
          `;
        } else if (order.status === 'ready') {
          buttons = `
            <button onclick="markPicked('${order.id}')" class="btn btn-primary" style="width: 100%;">üéÅ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß</button>
          `;
        }

        html += `
          <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <div style="font-weight: bold; font-size: 1.1em;">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå #${order.id?.substring(0, 8) || 'N/A'}</div>
              <span class="status-badge status-${order.status}">${statusTexts[order.status]}</span>
            </div>

            <div style="background: var(--light); padding: 10px; border-radius: 6px; margin-bottom: 10px; font-size: 0.9em;">
              ${itemsHtml}
            </div>

            <div style="font-weight: bold; margin-bottom: 15px;">üí∞ ‡∏£‡∏ß‡∏°: ${order.total}‡∏ø</div>

            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              ${buttons}
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function renderHistory() {
      const history = allOrders.filter(o => ['picked', 'rejected'].includes(o.status));
      const container = document.getElementById('historyContainer');

      if (history.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</p>';
        return;
      }

      const statusTexts = {
        'picked': 'üéÅ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß',
        'rejected': '‚ùå ‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò'
      };

      let html = '';
      history.forEach(order => {
        const itemsHtml = order.items
          .filter(item => item.restaurant === shopName)
          .map(item => `<div>- ${item.item} √ó ${item.qty}</div>`)
          .join('');

        html += `
          <div class="card">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
              <span style="font-weight: bold;">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå #${order.id?.substring(0, 8) || 'N/A'}</span>
              <span class="status-badge status-${order.status}">${statusTexts[order.status]}</span>
            </div>
            <div style="color: #666; font-size: 0.9em;">${itemsHtml}</div>
            <div style="margin-top: 10px; font-weight: bold; color: var(--primary);">üí∞ ${order.total}‡∏ø</div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    window.switchTab = function(tab) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      
      document.getElementById(tab).classList.add('active');
      event.target.classList.add('active');

      if (tab === 'history') {
        renderHistory();
      }
    };

    window.acceptOrder = async function(orderId) {
      try {
        await updateOrderStatus(orderId, 'accepted');
        alert('‚úÖ ‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß');
      } catch (e) {
        alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
      }
    };

    window.startPreparing = async function(orderId) {
      try {
        await updateOrderStatus(orderId, 'preparing');
        alert('‚úÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡πÅ‡∏•‡πâ‡∏ß');
      } catch (e) {
        alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
      }
    };

    window.markReady = async function(orderId) {
      try {
        await updateOrderStatus(orderId, 'ready');
        alert('‚úÖ ‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß');
      } catch (e) {
        alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
      }
    };

    window.markPicked = async function(orderId) {
      try {
        await updateOrderStatus(orderId, 'picked');
        alert('‚úÖ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß');
      } catch (e) {
        alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
      }
    };

    window.rejectOrder = async function(orderId) {
      if (!confirm('‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
      try {
        await updateOrderStatus(orderId, 'rejected');
        alert('‚úÖ ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß');
      } catch (e) {
        alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
      }
    };

    startListening();

    window.addEventListener('beforeunload', () => {
      if (unsubscribe) unsubscribe();
    });
  </script>
</body>
</html>